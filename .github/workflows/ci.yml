name: CI Pipeline (Monorepo)

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [develop]

env:
  JAVA_VERSION: 21

jobs:
  # Job 1: Detectar quais servi√ßos foram modificados
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      cliente-core-changed: ${{ steps.filter.outputs.cliente-core }}
      vendas-core-changed: ${{ steps.filter.outputs.vendas-core }}
      infrastructure-changed: ${{ steps.filter.outputs.infrastructure }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Check changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cliente-core:
              - 'services/cliente-core/**'
            vendas-core:
              - 'services/vendas-core/**'
            infrastructure:
              - 'infrastructure/**'
              - 'terraform/**'
              - 'docker-compose.yml'

  # Job 2: Build e Test cliente-core
  test-cliente-core:
    name: Test cliente-core
    needs: detect-changes
    if: needs.detect-changes.outputs.cliente-core-changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests with coverage
        working-directory: ./services/cliente-core
        env:
          SPRING_PROFILES_ACTIVE: test
        run: mvn clean verify

      - name: Upload coverage to Codecov
        if: success()
        uses: codecov/codecov-action@v4
        with:
          files: ./services/cliente-core/target/site/jacoco/jacoco.xml
          flags: cliente-core
          name: cliente-core-coverage
          fail_ci_if_error: false
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cliente-core-test-results
          path: services/cliente-core/target/surefire-reports/
          retention-days: 7

      - name: Build JAR artifact
        if: success()
        working-directory: ./services/cliente-core
        run: mvn clean package -DskipTests

      - name: Upload JAR artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: cliente-core-jar
          path: services/cliente-core/target/*.jar
          retention-days: 7

  # Job 3: Build e Test vendas-core (futuro)
  test-vendas-core:
    name: Test vendas-core
    needs: detect-changes
    if: needs.detect-changes.outputs.vendas-core-changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Placeholder for vendas-core tests
        run: |
          echo "vendas-core tests will be implemented when the service is ready"
          echo "This job ensures the CI workflow is prepared for multi-service testing"

  # Job 4: Lint Terraform/Infrastructure
  lint-infrastructure:
    name: Lint Infrastructure Code
    needs: detect-changes
    if: needs.detect-changes.outputs.infrastructure-changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Format Check
        working-directory: ./terraform/shared
        run: terraform fmt -check -recursive

      - name: Terraform Validate
        working-directory: ./terraform/shared
        run: |
          terraform init -backend=false
          terraform validate

      - name: TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Run TFLint
        working-directory: ./terraform/shared
        run: |
          tflint --init
          tflint --format compact

  # Job 5: Docker Build Validation
  validate-docker-builds:
    name: Validate Docker Builds
    needs: [detect-changes, test-cliente-core]
    if: needs.detect-changes.outputs.cliente-core-changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: cliente-core-jar
          path: services/cliente-core/target/

      - name: Build Docker image
        working-directory: ./services/cliente-core
        run: |
          docker build -t cliente-core:test .

      - name: Scan Docker image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'cliente-core:test'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

  # Job 6: Summary
  ci-summary:
    name: CI Summary
    needs: [test-cliente-core, test-vendas-core, lint-infrastructure, validate-docker-builds]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        env:
          CLIENTE_TEST_RESULT: ${{ needs.test-cliente-core.result }}
          VENDAS_TEST_RESULT: ${{ needs.test-vendas-core.result }}
          INFRA_LINT_RESULT: ${{ needs.lint-infrastructure.result }}
          DOCKER_RESULT: ${{ needs.validate-docker-builds.result }}
        run: |
          echo "## üìä CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # cliente-core
          if [[ "$CLIENTE_TEST_RESULT" == "success" ]]; then
            echo "‚úÖ **cliente-core tests:** PASSED" >> $GITHUB_STEP_SUMMARY
          elif [[ "$CLIENTE_TEST_RESULT" == "skipped" ]]; then
            echo "‚è≠Ô∏è  **cliente-core tests:** SKIPPED (no changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **cliente-core tests:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # vendas-core
          if [[ "$VENDAS_TEST_RESULT" == "success" ]]; then
            echo "‚úÖ **vendas-core tests:** PASSED" >> $GITHUB_STEP_SUMMARY
          elif [[ "$VENDAS_TEST_RESULT" == "skipped" ]]; then
            echo "‚è≠Ô∏è  **vendas-core tests:** SKIPPED (no changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **vendas-core tests:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Infrastructure
          if [[ "$INFRA_LINT_RESULT" == "success" ]]; then
            echo "‚úÖ **Infrastructure lint:** PASSED" >> $GITHUB_STEP_SUMMARY
          elif [[ "$INFRA_LINT_RESULT" == "skipped" ]]; then
            echo "‚è≠Ô∏è  **Infrastructure lint:** SKIPPED (no changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Infrastructure lint:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Docker
          if [[ "$DOCKER_RESULT" == "success" ]]; then
            echo "‚úÖ **Docker build:** PASSED" >> $GITHUB_STEP_SUMMARY
          elif [[ "$DOCKER_RESULT" == "skipped" ]]; then
            echo "‚è≠Ô∏è  **Docker build:** SKIPPED (no changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Docker build:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if any critical job failed
        env:
          CLIENTE_TEST_RESULT: ${{ needs.test-cliente-core.result }}
          VENDAS_TEST_RESULT: ${{ needs.test-vendas-core.result }}
        run: |
          if [[ "$CLIENTE_TEST_RESULT" == "failure" ]] || [[ "$VENDAS_TEST_RESULT" == "failure" ]]; then
            echo "‚ùå CI pipeline failed. Check the logs above."
            exit 1
          fi

          echo "‚úÖ All CI checks passed!"
